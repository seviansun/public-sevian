/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: Mar 23 12:19
*/
KISSY.add("waterfall/base",function(i,s,v){function k(){k.superclass.constructor.apply(this,arguments);this._init()}function t(a,c,b,d){var e=[].concat(i.makeArray(a)),f={},n;if(e.length>0)n=setTimeout(function(){var g=+new Date;do{var j=e.shift();c.call(b,j)}while(e.length>0&&+new Date-g<50);if(e.length>0)n=setTimeout(arguments.callee,25);else d&&d.call(b,a)},25);else d&&i.later(d,0,false,b,[a]);f.stop=function(){if(n){clearTimeout(n);e=[];a.each(function(g){g.stop()})}};return f}function w(){var a=
this._containerRegion;a&&this.get("container").width()===a.width||this.adjust()}function r(){var a=this.get("container").width(),c=this.get("curColHeights");c.length=Math.max(parseInt(a/this.get("colWidth")),this.get("minColCount"));this._containerRegion={width:a};i.each(c,function(b,d){c[d]=0});this.set("colItems",[])}function o(a,c,b,d){var e=a.get("effect");b=p(b);for(var f=a.get("curColHeights"),n=a.get("container"),g=f.length,j=0,u=a._containerRegion,h=Number.MAX_VALUE,l=0;l<g;l++)if(f[l]<h){h=
f[l];j=l}g||(h=0);g=Math.max(u.width-g*a.get("colWidth"),0)/2;h={left:j*a.get("colWidth")+g,top:h};if(c){b.css(h);e&&e.effect&&b.css("visibility","hidden");n.append(b);d&&d()}else if(c=a.get("adjustEffect"))b.animate(h,c.duration,c.easing,d);else{b.css(h);d&&d()}f[j]+=b.outerHeight(true);a=a.get("colItems");a[j]=a[j]||[];a[j].push(b);b.attr("data-waterfall-col",j);return b}function q(a){a=o(this,true,a);var c=this.get("effect");if(c&&c.effect){a.hide();a.css("visibility","");a[c.effect](c.duration,
0,c.easing)}}var p=s.all,m=i.Env.host;k.ATTRS={container:{setter:function(a){return p(a)}},curColHeights:{value:[]},minColCount:{value:1},effect:{value:{effect:"fadeIn",duration:1}},colWidth:{},colItems:{value:[]},adjustEffect:{}};i.extend(k,v,{isAdjusting:function(){return!!this._adjuster},_init:function(){w.call(this);this.__onResize=i.buffer(w,50,this);p(m).on("resize",this.__onResize)},adjustItem:function(a,c){function b(){y--;if(y<=0){d._adjuster=0;c&&c.callback&&c.callback.call(d)}}var d=this;
if(!d.isAdjusting()){var e=a.outerHeight(true),f;if(c.process)f=c.process.call(d);if(f===undefined)f=a.outerHeight(true);var n=f-e,g=d.get("curColHeights"),j=parseInt(a.attr("data-waterfall-col")),u=d.get("colItems")[j];e=[];f=Math.max.apply(Math,g);for(var h=0;h<u.length;h++)if(u[h][0]===a[0])break;for(h++;h<u.length;){e.push(u[h]);h++}g[j]+=n;g=Math.max.apply(Math,g);g!=f&&d.get("container").height(g);var l=c.effect,y=e.length;if(l===undefined)l=d.get("adjustEffect");if(!y)return b();return d._adjuster=
t(e,function(x){if(l)x.animate({top:parseInt(x.css("top"))+n},l.duration,l.easing,b);else{x.css("top",parseInt(x.css("top"))+n);b()}})}},removeItem:function(a,c){c=c||{};var b=this,d=c.callback;b.adjustItem(a,i.mix(c,{process:function(){a.remove();return 0},callback:function(){var e=parseInt(a.attr("data-waterfall-col"));e=b.get("colItems")[e];for(var f=0;f<e.length;f++)if(e[f][0]==a[0]){e.splice(f,1);break}d&&d()}}))},adjust:function(a){function c(){e--;if(e<=0){b.get("container").height(Math.max.apply(Math,
b.get("curColHeights")));b._adjuster=0;a&&a.call(b);d.length&&b.fire("adjustComplete",{items:d})}}var b=this,d=b.get("container").all(".ks-waterfall");if(b.isAdjusting()){b._adjuster.stop();b._adjuster=0}r.call(b);var e=d.length;if(!e)return c();return b._adjuster=t(d,function(f){o(b,false,f,c)})},addItems:function(a,c){var b=this;b._adder=t(a,q,b,function(){b.get("container").height(Math.max.apply(Math,b.get("curColHeights")));b._adder=0;c&&c.call(b);a.length&&b.fire("addComplete",{items:a})});return b._adder},
destroy:function(){p(m).detach("resize",this.__onResize)}});return k},{requires:["node","base"]});
KISSY.add("waterfall/loader",function(i,s,v){function k(){k.superclass.constructor.apply(this,arguments)}function t(){if(!this.__pause)if(!this.__loading)if(this.isAdjusting())this.__onScroll();else{var q=this.get("container").offset().top,p=this.get("diff"),m=this.get("curColHeights");if(m.length)q+=Math.min.apply(Math,m);p+r(o).scrollTop()+r(o).height()>q&&w.call(this)}}function w(){function q(c){m.__loading=0;m.addItems(c)}function p(){m.end()}var m=this;this.get("container");m.__loading=1;var a=
m.get("load");a&&a(q,p)}var r=s.all,o=i.Env.host;k.ATTRS={diff:{getter:function(q){return q||0}}};i.extend(k,v,{_init:function(){k.superclass._init.apply(this,arguments);this.__onScroll=i.buffer(t,50,this);r(o).on("scroll",this.__onScroll);t.call(this)},end:function(){r(o).detach("scroll",this.__onScroll)},pause:function(){this.__pause=1},resume:function(){this.__pause=0},destroy:function(){k.superclass.destroy.apply(this,arguments);r(o).detach("scroll",this.__onScroll)}});return k},{requires:["node",
"./base"]});KISSY.add("waterfall",function(i,s,v){s.Loader=v;return s},{requires:["waterfall/base","waterfall/loader"]});
